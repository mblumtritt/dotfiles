#! /usr/bin/env ruby
# frozen_string_literal: true

NAME = File.basename(__FILE__)

def help
  puts <<~HELP
    usage: #{NAME} [options] <project_name>

    valid options:
      -t, --top   display first matching project

      Display all projects matching <project_name> shortcut.
  HELP
  exit 0
end

def help?(str)
  str.nil? || str == 'help' || str == 'h' || str == '-h' || str == '--help'
end

def top_only?(str)
  str == '-t' || str == '--top'
end

def read_roots(file_name = '~/.' + NAME)
  IO
    .readlines(File.expand_path(file_name))
    .map!(&:strip)
    .delete_if do |name|
      name.nil? || name.empty? || name.start_with?('#')
    end
rescue SystemCallError
  $stderr.puts "#{NAME}: configuration not found - #{file_name}"
  exit 3
end

help if help?(option = ARGV.shift)
top_ponly = top_only?(option) && option = ARGV.shift
exit 2 if option.nil?

class ProjectsFinder
  def initialize(roots)
    @roots, @map = roots, nil
  end

  def map
    @map ||= create_map
  end

  def related_dirs(name)
    dirs_for(related_keys(name))
  end

  private

  def normalized(str)
    str.downcase.tr('-._', '')
  end

  def related_keys(name)
    name = normalized(name)
    map
      .keys
      .find_all{ |key| key.index(name) }
      .sort_by!{ |key| key.size - name.size }
  end

  def dirs_for(keys)
    ret = []
    keys.each{ |key| ret << map[key] }
    ret.flatten!
    ret.uniq!
    ret
  end

  def create_map
    ret = Hash.new{ |h, k| h[k] = [] }
    @roots.each do |root|
      root = File.expand_path(root)
      next unless File.directory?(root)
      Dir.glob(root + '/*') do |file_name|
        next unless File.directory?(file_name)
        name = normalized(File.basename(file_name))
        ret[name] << file_name
      end
    end
    ret
  end
end

found = ProjectsFinder.new(read_roots).related_dirs(option)
exit 1 if found.empty?
top_ponly ? puts(found[0]) : found.each{ |f| puts f }
